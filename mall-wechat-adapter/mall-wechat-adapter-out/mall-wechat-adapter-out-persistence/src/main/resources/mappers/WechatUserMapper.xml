<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.wechat.adapter.out.persistence.mapper.WechatUserMapper">

    <!-- 根据OpenID查询微信用户 -->
    <select id="findByOpenId" resultType="com.mall.wechat.domain.model.wechatuser.WechatUser">
        SELECT user_id, city, country, group_id, head_img_url, language, nick_name, 
               open_id, province, remark, sex, subscribe_time, union_id, wechat_tag_id,
               created_at, created_by, updated_at, updated_by, is_deleted
        FROM wechat_user 
        WHERE open_id = #{openId} AND is_deleted = 0
    </select>

    <!-- 根据标签ID查询微信用户列表 -->
    <select id="findByWechatTagId" resultType="com.mall.wechat.domain.model.wechatuser.WechatUser">
        SELECT user_id, city, country, group_id, head_img_url, language, nick_name, 
               open_id, province, remark, sex, subscribe_time, union_id, wechat_tag_id,
               created_at, created_by, updated_at, updated_by, is_deleted
        FROM wechat_user 
        WHERE wechat_tag_id = #{wechatTagId} AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 检查OpenID是否存在 -->
    <select id="countByOpenId" resultType="int">
        SELECT COUNT(1) 
        FROM wechat_user 
        WHERE open_id = #{openId} AND is_deleted = 0
    </select>

</mapper>